function UC_UserController(){var a=this;this.config={},this.emailSetting={},this.browserNotificationSetting={},this.rivetAppNameEmailObj=null,this.rivetAppNameBrowserNotificationObj=null,this.constructor=function(){$(document).on("click",".ucEditProfile",a.editProfileHandler),$(document).on("click",".ucChangePassword",a.editPasswordHandler),$(document).on("click",".ucEditMail",a.editMailHandler),$(document).on("click",".ucEditBrowserNotification",a.editBrowserNotificationHandler),$(document).on("click",".ucEditDatabase",a.editDatabaseHandler),$(document).on("click",".ucEditSystem",a.editSystemHandler),$(document).on("click","#uceditprofile_submit",a.handleProfileSaveAction),$(document).on("click","#ucchangepassword_submit",a.handlePasswordSaveAction),$(document).on("click","#uceditmail_submit",a.handleMailSaveAction),$(document).on("click","#uceditbrowsernotification_submit",a.handleBrowserNotificationSaveAction),$(document).on("click","#uceditdatabase_submit",a.handleDatabaseSaveAction),$(document).on("click","#uceditsystem_submit",a.handleSystemSaveAction),$(document).on("click","#ucEditEmailTypeTabGroup button",a.handleTypeSelectionAction),a.getConfig(),a.rivetAppNameEmailObj=rivets.bind(document.querySelector("#ucEmailSettings_App"),{appName:""}),a.rivetAppNameBrowserNotificationObj=rivets.bind(document.querySelector("#ucBrowserNotificationSettings_App"),{appName:""})},this.editProfileHandler=function(a){var b=UC_UserSession.user;$("#uceditprofile_firstname").val(b.firstName),$("#uceditprofile_lastname").val(b.lastName),$("#ucEditProfileModal").modal(),$("#uceditprofile_submit").button("reset"),a.preventDefault()},this.handleProfileSaveAction=function(b){b.preventDefault();var c=$("#uceditprofile_firstname").val(),d=$("#uceditprofile_lastname").val(),e=a.validateProfileInputs();if("failure"==e.status)return void alert(e.msg);var f=UC_UserSession.user;f.firstName=c,f.lastName=d,UC_UserSession.user=f,$("#uceditprofile_submit").button("loading"),UC_AJAX.call("UserManager/saveUserProfile",{user:f},function(a,b,c){a&&("failure"==a.status?alert("An Error accured while saving data !"):"authenticationfailed"==a.status?location.href="/":(alert("Profile saved successfully"),uc_main.rivetUserNameObj.models.currentUserName=f.firstName+" "+f.lastName,$("#ucEditProfileModal").modal("hide"))),$("#uceditprofile_submit").button("reset")})},this.validateProfileInputs=function(){var a={status:"success",msg:""},b=$("#uceditprofile_firstname").val(),c=$("#uceditprofile_lastname").val(),d="";return""==$.trim(b)?d="Invalid First Name":""==$.trim(c)&&(d="Invalid Last Name"),""!=d&&(a.status="failure",a.msg=d),a},this.editPasswordHandler=function(a){$("#ucEditPasswordModal").modal(),$("#ucchangepassword_submit").button("reset"),a.preventDefault()},this.handlePasswordSaveAction=function(b){b.preventDefault();var c=$("#ucchangepassword_password").val(),d=($("#ucchangepassword_confirmpassword").val(),a.validatePasswordInputs());if("failure"==d.status)return void alert(d.msg);var e=UC_UserSession.user;e.password=c,UC_UserSession.user=e,$("#ucchangepassword_submit").button("loading"),UC_AJAX.call("UserManager/saveUserPassword",{user:e},function(a,b,c){a&&(delete UC_UserSession.user.password,"failure"==a.status?alert("An Error accured while saving data !"):"authenticationfailed"==a.status?location.href="/":(alert("Password changed successfully"),$("#ucEditPasswordModal").modal("hide")),$("#ucchangepassword_submit").button("reset"))})},this.validatePasswordInputs=function(){var a={status:"success",msg:""},b=$("#ucchangepassword_password").val(),c=$("#ucchangepassword_confirmpassword").val(),d="";return""==$.trim(b)?d="Invalid Password !":$.trim(b)!=$.trim(c)&&(d="Confirm Password should match the New Password field"),""!=d&&(a.status="failure",a.msg=d),a},this.editMailHandler=function(b){var c=UC_UserSession.user;$("#uceditsmtp_host,#uceditsmtp_port,#uceditsmtp_user,#uceditsmtp_pass,#uceditmailgun_key,#uceditmailgun_domain,#uceditmailgun_from,#uceditamazon_key,#uceditamazon_secret,#uceditamazon_region,#uceditamazon_from").val(""),UC_AJAX.call("EmailManager/getemailsetting",{appId:uc_main.appController.currentAppId,company:c.company},function(b,c,d){if(b)if("failure"==b.status)alert("An Error accured while retrieving email settings!");else if("authenticationfailed"==b.status)location.href="/";else{a.emailSetting=b.emailsetting;var e=uc_main.appController.currentAppId,f=UC_Utils.searchObjArray(uc_main.appController.apps,"_id",e);a.rivetAppNameEmailObj.models.appName=uc_main.appController.apps[f].name,a.emailSetting.emailType?a.currentEmailType=a.emailSetting.emailType:a.currentEmailType="SMTP",$(".ucEditEmailContainer").hide(),$("#ucEditEmail"+a.currentEmailType+"Container").show(),$("#ucEditEmailTypeTabGroup button").removeClass("active"),$("#ucEditEmailTypeTabGroup button[data-tabgroup-tabid=ucEditEmail"+a.currentEmailType+"Container]").addClass("active"),a.emailSetting.smtp&&($("#uceditsmtp_host").val(a.emailSetting.smtp.host),$("#uceditsmtp_port").val(a.emailSetting.smtp.port),$("#uceditsmtp_user").val(a.emailSetting.smtp.user),$("#uceditsmtp_pass").val(a.emailSetting.smtp.pass)),a.emailSetting.mailgun&&($("#uceditmailgun_key").val(a.emailSetting.mailgun.key),$("#uceditmailgun_domain").val(a.emailSetting.mailgun.domain),$("#uceditmailgun_from").val(a.emailSetting.mailgun.from)),a.emailSetting.amazon&&($("#uceditamazon_key").val(a.emailSetting.amazon.key),$("#uceditamazon_secret").val(a.emailSetting.amazon.secret),$("#uceditamazon_region").val(a.emailSetting.amazon.region),$("#uceditamazon_from").val(a.emailSetting.amazon.from)),$("#ucEditMailModal").modal(),$("#uceditmail_submit").button("reset")}}),b.preventDefault()},this.editBrowserNotificationHandler=function(b){var c=UC_UserSession.user;$("#uceditbrowsernotification_fcmkey,#uceditbrowsernotification_fcmsenderid,#uceditbrowsernotification_fcmappname,#uceditbrowsernotification_icon").val(""),UC_AJAX.call("BrowserNotificationManager/getbrowsernotificationsetting",{appId:uc_main.appController.currentAppId,company:c.company},function(b,c,d){if(b)if("failure"==b.status)alert("An Error accured while retrieving browser notification settings!");else if("authenticationfailed"==b.status)location.href="/";else{a.browserNotificationSetting=b.browserNotificationSetting;var e=uc_main.appController.currentAppId,f=UC_Utils.searchObjArray(uc_main.appController.apps,"_id",e);a.rivetAppNameBrowserNotificationObj.models.appName=uc_main.appController.apps[f].name,$("#uceditbrowsernotification_fcmkey").val(a.browserNotificationSetting.fcmKey),$("#uceditbrowsernotification_fcmsenderid").val(a.browserNotificationSetting.fcmSenderId),$("#uceditbrowsernotification_fcmappname").val(a.browserNotificationSetting.fcmAppName),$("#uceditbrowsernotification_icon").val(a.browserNotificationSetting.icon),$("#ucEditBrowserNotificationModal").modal(),$("#uceditbrowsernotification_submit").button("reset")}}),b.preventDefault()},this.handleMailSaveAction=function(b){if(b.preventDefault(),"SMTP"==a.currentEmailType){var c=$("#uceditsmtp_host").val(),d=$("#uceditsmtp_port").val(),e=$("#uceditsmtp_user").val(),f=$("#uceditsmtp_pass").val(),g=a.validateSMTPInputs();if("failure"==g.status)return void alert(g.msg);a.emailSetting.emailType="SMTP",a.emailSetting.smtp.host=c,a.emailSetting.smtp.port=d,a.emailSetting.smtp.user=e,a.emailSetting.smtp.pass=f}else if("Mailgun"==a.currentEmailType){var h=$("#uceditmailgun_key").val(),i=$("#uceditmailgun_domain").val(),j=$("#uceditmailgun_from").val(),g=a.validateMailgunInputs();if("failure"==g.status)return void alert(g.msg);a.emailSetting.emailType="Mailgun",a.emailSetting.mailgun={},a.emailSetting.mailgun.key=h,a.emailSetting.mailgun.domain=i,a.emailSetting.mailgun.from=j}else if("Amazon"==a.currentEmailType){var k=$("#uceditamazon_key").val(),l=$("#uceditamazon_secret").val(),m=$("#uceditamazon_region").val(),n=$("#uceditamazon_from").val(),g=a.validateAmazonInputs();if("failure"==g.status)return void alert(g.msg);a.emailSetting.emailType="Amazon",a.emailSetting.amazon={},a.emailSetting.amazon.key=k,a.emailSetting.amazon.secret=l,a.emailSetting.amazon.region=m,a.emailSetting.amazon.from=n}a.emailSetting.appId=uc_main.appController.currentAppId,$("#uceditmail_submit").button("loading");var o=UC_UserSession.user;UC_AJAX.call("EmailManager/saveemailsetting",{user:o,emailSetting:a.emailSetting},function(a,b,c){a&&("failure"==a.status?alert("An Error accured while saving email settings!"):"authenticationfailed"==a.status?location.href="/":(alert("Email settings changed successfully"),$("#ucEditMailModal").modal("hide")),$("#uceditmail_submit").button("reset"))})},this.handleBrowserNotificationSaveAction=function(b){b.preventDefault();var c=$("#uceditbrowsernotification_fcmkey").val(),d=$("#uceditbrowsernotification_fcmsenderid").val(),e=$("#uceditbrowsernotification_fcmappname").val(),f=$("#uceditbrowsernotification_icon").val();a.browserNotificationSetting.fcmKey=c,a.browserNotificationSetting.fcmSenderId=d,a.browserNotificationSetting.fcmAppName=e,a.browserNotificationSetting.icon=f,a.browserNotificationSetting.appId=uc_main.appController.currentAppId,$("#uceditbrowsernotification_submit").button("loading");var g=UC_UserSession.user;UC_AJAX.call("BrowserNotificationManager/savebrowsernotificationsetting",{user:g,browserNotificationSetting:a.browserNotificationSetting},function(a,b,c){a&&("failure"==a.status?alert("An Error accured while saving browser notification settings!"):"authenticationfailed"==a.status?location.href="/":(alert("Browser Notification settings changed successfully"),$("#ucEditBrowserNotificationModal").modal("hide")),$("#uceditbrowsernotification_submit").button("reset"))})},this.validateSMTPInputs=function(){var a={status:"success",msg:""},b=$("#uceditsmtp_host").val(),c=$("#uceditsmtp_port").val(),d="";return""==$.trim(b)?d="Invalid Host Name !":""==$.trim(c)&&(d="Invalid Port !"),""!=d&&(a.status="failure",a.msg=d),a},this.validateMailgunInputs=function(){var a={status:"success",msg:""},b=$("#uceditmailgun_key").val(),c=$("#uceditmailgun_domain").val(),d=$("#uceditmailgun_from").val(),e="";return""==$.trim(b)?e="Invalid Key":""==$.trim(c)?e="Invalid Domain":""==$.trim(d)&&(e="Invalid From email"),""!=e&&(a.status="failure",a.msg=e),a},this.validateAmazonInputs=function(){var a={status:"success",msg:""},b=$("#uceditamazon_key").val(),c=$("#uceditamazon_secret").val(),d=$("#uceditamazon_region").val(),e=$("#uceditamazon_from").val(),f="";return""==$.trim(b)?f="Invalid Key !":""==$.trim(c)?f="Invalid Secret !":""==$.trim(d)?f="Invalid Region !":""==$.trim(e)&&(f="Invalid From Email !"),""!=f&&(a.status="failure",a.msg=f),a},this.editDatabaseHandler=function(b){$("#uceditdatabase_host").val(a.config.database.host),$("#uceditdatabase_port").val(a.config.database.port),$("#uceditdatabase_user").val(a.config.database.user),$("#uceditdatabase_connectionstring").val(a.config.database.connectionstring),$("#ucEditDatabaseTabGroup .uc_tab_trigger").removeClass("active"),$("#ucEditDatabaseTabGroup .uc_tab_trigger[data-connectionType="+a.config.database.connectiontype+"]").addClass("active"),$(".ucEditDatabaseContainer").hide(),$("#ucEditDatabase"+a.config.database.connectiontype+"Container").show(),$("#ucEditDatabaseModal").modal(),$("#uceditdatabase_submit").button("reset"),b.preventDefault()},this.handleDatabaseSaveAction=function(b){b.preventDefault();var c=$("#uceditdatabase_host").val(),d=$("#uceditdatabase_port").val(),e=$("#uceditdatabase_user").val(),f=$("#uceditdatabase_pass").val(),g=$("#uceditdatabase_connectionstring").val(),h=$("#ucEditDatabaseTabGroup .active").attr("data-connectionType"),i=a.validateDatabaseInputs();if("failure"==i.status)return void alert(i.msg);a.config.database.host=c,a.config.database.port=d,a.config.database.user=e,a.config.database.pass=f,a.config.database.connectionstring=g,a.config.database.connectiontype=h,$("#uceditdatabase_submit").button("loading"),UC_AJAX.call("UserManager/verifydbconnection",{dbhost:c,dbport:d,dbuser:e,dbpass:f,dbname:a.config.database.name,dbconnectionstring:g,dbconnectiontype:h},function(b,c,d){b&&("connected"==b.status?UC_AJAX.call("UserManager/saveconfig",{config:a.config},function(a,b,c){a&&("failure"==a.status?alert("An Error accured while saving config file!"):(alert("Database settings changed successfully"),$("#ucEditDatabaseModal").modal("hide")),$("#uceditdatabase_submit").button("reset"))}):"failure"==b.status?(alert("Database connection cannot be established with the provided details"),$("#uceditdatabase_submit").button("reset")):(alert("An Error accured while saving data. Try again!"),$("#uceditdatabase_submit").button("reset")))})},this.validateDatabaseInputs=function(){var a={status:"success",msg:""},b=$("#uceditdatabase_host").val(),c=$("#uceditdatabase_port").val(),d=$("#uceditdatabase_connectionstring").val(),e=$("#ucEditDatabaseTabGroup .active").attr("data-connectionType"),f="";return"Simple"==e?""==$.trim(b)?f="Invalid Host Name !":""==$.trim(c)&&(f="Invalid Port !"):"Advanced"==e?""==$.trim(d)&&(f="Invalid Connection String"):f="Invalid Connection Type",""!=f&&(a.status="failure",a.msg=f),a},this.editSystemHandler=function(b){$("#uceditsystem_baseurl").val(a.config.baseURL);var c=moment.tz.names();$("#uceditsystem_timezoneinput").html(""),$("#uceditsystem_timezoneinput").append('<option value="">Select a Timezone</option>');for(var d=0;d<c.length;d++){var e="";UC_UserSession.user.companyTimezone==c[d]&&(e=" selected"),$("#uceditsystem_timezoneinput").append('<option value="'+c[d]+'"'+e+">"+c[d]+" ("+moment.tz(c[d]).format("Z")+")</option>")}$("#uceditsystem_timezoneinput").select2(),$("#ucEditSystemModal").modal(),$("#uceditsystem_submit").button("reset"),b.preventDefault()},this.handleSystemSaveAction=function(b){b.preventDefault();var c=$("#uceditsystem_baseurl").val(),d=$("#uceditsystem_timezoneinput").val(),e=a.validateSystemInputs();if("failure"==e.status)return void alert(e.msg);"/"==c.substr(c.length-1)&&(c=c.substr(0,c.length-1)),a.config.baseURL=c,$("#uceditsystem_submit").button("loading"),UC_AJAX.call("UserManager/updateTimezone",{user:UC_UserSession.user,timezone:d},function(b,c,d){"authenticationfailed"==b.status?location.href="/":"failure"==b.status?alert("An Error accured while saving data !"):UC_AJAX.call("UserManager/saveconfig",{config:a.config},function(a,b,c){a&&("failure"==a.status?(alert("An Error accured while saving config file!"),$("#uceditsystem_submit").button("reset")):setTimeout(function(){UC_AJAX.call("AppManager/regeneratetrackjs",{user:UC_UserSession.user,appId:null},function(a,b,c){"failure"==a.status?alert("An Error accured while generating trackjs"):"authenticationfailed"==a.status?location.href="/":(alert("System settings changed successfully"),$("#ucEditSystemModal").modal("hide")),$("#uceditsystem_submit").button("reset")})},3e3))})})},this.validateSystemInputs=function(){var a={status:"success",msg:""},b=$("#uceditsystem_baseurl").val(),c=$("#uceditsystem_timezoneinput").val(),d="";return"/"==b.substr(b.length-1)&&(b=b.substr(0,b.length-1)),""==$.trim(b)?d="Invalid Base URL":""==$.trim(c)&&(d="Invalid Timezone"),""!=d&&(a.status="failure",a.msg=d),a},this.handleTypeSelectionAction=function(){a.currentEmailType=$(this).attr("data-emailType")},this.getConfig=function(){UC_AJAX.call("UserManager/getconfig",{user:UC_UserSession.user},function(b,c,d){a.config=b.config})}}function UC_UserRegistrationController(){var a=this;this.config={},this.setupappId="",this.timezoneList=[],this.constructor=function(){this.bindUIEvents(),$("#UC_Setup_Welcome_Page").show(),a.constructTimezoneArray(),$(".uc_tab_trigger").on("click",a.toggleTabs)},this.bindUIEvents=function(){$("#ucsetup_getting_startedbtn").on("click",a.handleGettingStartedBtnAction),$("#ucuserreg_submitbtn").on("click",a.handleRegisterBtnAction),$("#ucsetup_dbsubmitbtn").on("click",a.handleSetupDBAction),$("#ucsetup_usersubmitbtn").on("click",a.handleSetupUserAction),$("#ucsetup_appsubmitbtn").on("click",a.handleSetupAppAction),$("#ucsetup_smtpsubmitbtn").on("click",a.handleSetupSMTPAction)},this.handleGettingStartedBtnAction=function(){$(".UC_SetupContainerCls").hide(),$("#UC_Setup_Database").show(),$(".ucSetupProgressSteps li").removeClass("active"),$(".uc_database_details").addClass("active"),$("#ucsetup_dbsubmitbtn").button("reset")},this.handleRegisterBtnAction=function(){var b=$("#ucuserreg_emailinput").val(),c=$("#ucuserreg_passwordinput").val(),d=($("#ucuserreg_confirmpasswordinput").val(),$("#ucuserreg_fullnameinput").val()),e=a.validateUserRegistrationInputs();if("failure"==e.status)return void alert(e.msg);var f=new UC_User;f._id=b,f.username=b,f.firstName=d,f.password=c,f.company="C"+UC_Utils.guidGenerator(),a.sendLoginRequest(f,!0)},this.validateUserRegistrationInputs=function(){var a={status:"success",msg:""},b=$("#ucuserreg_emailinput").val(),c=$("#ucuserreg_passwordinput").val(),d=$("#ucuserreg_confirmpasswordinput").val(),e=$("#ucuserreg_fullnameinput").val(),f="";return""==$.trim(e)?f="Invalid Name !":""!=$.trim(b)&&UC_Utils.isValidEmail(b)?""==$.trim(c)?f="Invalid Password !":c!=d&&(f="Password & Confirm Password doesn't match !"):f="Invalid Email !",""!=f&&(a.status="failure",a.msg=f),a},this.sendLoginRequest=function(a,b){b||$("#ucsetup_usersubmitbtn").button("loading"),UC_AJAX.call("UserManager/registerUser",{user:a},function(c,d,e){c&&("userexists"==c.status?alert("Username already exists !"):"failure"==c.status?alert("An Error accured while saving data !"):b?location.href="/login":(UC_UserSession.user=a,$(".UC_SetupContainerCls").hide(),$("#UC_Setup_App").show(),$(".ucSetupProgressSteps li").removeClass("active"),$(".uc_user_settings").addClass("active"),$("#UC_Setup_Progress_Step").text("3"),$("#ucsetup_usersubmitbtn").button("reset"),$("#ucsetup_appsubmitbtn").button("reset")))})},this.handleSetupDBAction=function(b){b.preventDefault();var c=$("#ucsetup_dbhostinput").val(),d=$("#ucsetup_dbportinput").val(),e=$("#ucsetup_dbuserinput").val(),f=$("#ucsetup_dbpassinput").val(),g=$("#ucsetup_dbnameinput").val(),h=$("#ucsetup_dbconnectionstringinput").val(),i=$("#ucSetupDatabaseTabGroup .active").attr("data-connectionType"),j=a.validateSetupDBInputs();if("failure"==j.status)return void alert(j.msg);$("#ucsetup_dbsubmitbtn").button("loading"),UC_AJAX.call("UserManager/verifydbconnection",{dbhost:c,dbport:d,dbuser:e,dbpass:f,dbname:g,dbconnectionstring:h,dbconnectiontype:i},function(b,j,k){b&&("connected"==b.status?(a.config.database={},a.config.database.host=c,a.config.database.port=d,a.config.database.user=e,a.config.database.pass=f,a.config.database.name=g,a.config.database.connectionstring=h,a.config.database.connectiontype=i,a.saveConfig(!1),$(".UC_SetupContainerCls").hide(),$("#UC_Setup_User").show(),$("#UC_Setup_Progress_Step").text("2"),$(".ucSetupProgressSteps li").removeClass("active"),$(".uc_admin_details").addClass("active"),$("#ucsetup_usersubmitbtn").button("reset")):"failure"==b.status?alert("Database connection cannot be established with the provided details"):alert("An Error accured while saving data. Try again!"),$("#ucsetup_dbsubmitbtn").button("reset"))})},this.handleSetupSMTPAction=function(b){b.preventDefault();var c,d=$("#ucsetup_smtphostinput").val(),e=$("#ucsetup_smtpportinput").val(),f=$("#ucsetup_smtpuserinput").val(),g=$("#ucsetup_smtppassinput").val(),c={emailType:"SMTP",smtp:{host:d,port:e,user:f,pass:g},appId:a.setupappId},h=UC_UserSession.user;$("#ucsetup_smtpsubmitbtn").button("loading"),UC_AJAX.call("EmailManager/getemailsetting",{appId:a.setupappId,company:h.company},function(b,d,e){b&&("failure"==b.status?alert("Error in adding Email settings"):(newEmailSetting=b.emailsetting,newEmailSetting.smtp=c.smtp,UC_AJAX.call("EmailManager/saveemailsetting",{user:h,emailSetting:newEmailSetting},function(b,c,d){b&&("failure"==b.status?alert("Error in adding Email settings"):(a.config.setupCompleted=1,a.saveConfig(function(){location.href="/"})))})))})},this.handleSetupUserAction=function(b){b.preventDefault();var c=$("#ucsetup_emailinput").val(),d=$("#ucsetup_passwordinput").val(),e=($("#ucsetup_confirmpasswordinput").val(),$("#ucsetup_fullnameinput").val()),f=a.validateSetupUserInputs();if("failure"==f.status)return void alert(f.msg);var g=new UC_User;g._id=c,g.username=c,g.firstName=e,g.password=d,g.password=d,g.company="C"+UC_Utils.guidGenerator(),a.sendLoginRequest(g,!1)},this.handleSetupAppAction=function(b){b.preventDefault();var c=$("#ucsetup_baseurlinput").val(),d=$("#ucsetup_appnameinput").val(),e=$("#ucsetup_timezoneinput").val(),f=a.validateSetupAppInputs();if("failure"==f.status)return void alert(f.msg);"/"==c.substr(c.length-1)&&(c=c.substr(0,c.length-1)),a.config.baseURL=c;var g=new UC_App,h=UC_UserSession.user;g.name=d,g.creator=h.username,g._id=UC_Utils.guidGenerator(),g.clientId=h.company,a.setupappId=g._id,$("#ucsetup_appsubmitbtn").button("loading"),a.saveConfig(function(){UC_AJAX.call("AppManager/createNewApp",{newApp:g,user:h},function(a,b,c){"appexists"==a.status?alert("App with this name already exists !"):"authenticationfailed"==a.status?location.href="/":"failure"==a.status?alert("An Error accured while saving data !"):(UC_UserSession.user.company=a.status.clientId,setTimeout(function(){UC_AJAX.call("UserManager/updateTimezone",{user:h,timezone:e},function(a,b,c){"authenticationfailed"==a.status?location.href="/":"failure"==a.status?alert("An Error accured while saving data !"):($(".UC_SetupContainerCls").hide(),$("#UC_Setup_SMTP").show(),$("#UC_Setup_Progress_Step").text("4"),$(".ucSetupProgressSteps li").removeClass("active"),$(".uc_smtp_details").addClass("active"),$("#ucsetup_smtpsubmitbtn").button("reset")),$("#ucsetup_appsubmitbtn").button("reset")})},3e3))})})},this.validateSetupDBInputs=function(){var a={status:"success",msg:""},b=$("#ucsetup_dbhostinput").val(),c=$("#ucsetup_dbportinput").val(),d=($("#ucsetup_dbuserinput").val(),$("#ucsetup_dbpassinput").val(),$("#ucsetup_dbnameinput").val()),e=$("#ucsetup_dbconnectionstringinput").val(),f="",g=$("#ucSetupDatabaseTabGroup .active").attr("data-connectionType");return"Simple"==g?""==$.trim(b)?f="Invalid Database Host !":""==$.trim(c)?f="Invalid Database Port !":""==$.trim(d)&&(f="Invalid Database Name !"):"Advanced"==g?""==$.trim(e)&&(f="Invalid Connection String"):f="Invalid Connection Type",""!=f&&(a.status="failure",a.msg=f),a},this.validateSetupUserInputs=function(){var a={status:"success",msg:""},b=$("#ucsetup_emailinput").val(),c=$("#ucsetup_passwordinput").val(),d=$("#ucsetup_confirmpasswordinput").val(),e=$("#ucsetup_fullnameinput").val(),f="";return""==$.trim(e)?f="Invalid Name !":""!=$.trim(b)&&UC_Utils.isValidEmail(b)?""==$.trim(c)?f="Invalid Password !":c!=d&&(f="Password & Confirm Password doesn't match !"):f="Invalid Email !",""!=f&&(a.status="failure",a.msg=f),a},this.validateSetupAppInputs=function(){var a={status:"success",msg:""},b=$("#ucsetup_baseurlinput").val(),c=$("#ucsetup_appnameinput").val(),d=$("#ucsetup_timezoneinput").val(),e="";return"/"==b.substr(b.length-1)&&(b=b.substr(0,b.length-1)),""==$.trim(b)?e="Invalid Base URL !":""==$.trim(c)?e="Invalid App Name !":""==$.trim(d)&&(e="Select a Timezone"),""!=e&&(a.status="failure",a.msg=e),a},this.saveConfig=function(b){UC_AJAX.call("UserManager/saveconfig",{config:a.config},function(a,c,d){a&&("failure"==a.status?alert("An Error accured while saving config file!"):b&&setTimeout(function(){b()},6e3)),$("#ucsetup_usersubmitbtn").button("reset")})},this.constructTimezoneArray=function(){$("#ucsetup_timezoneinput").html(""),$("#ucsetup_timezoneinput").append('<option value="">Select a Timezone</option>');for(var b=0;b<a.timezoneList.length;b++)$("#ucsetup_timezoneinput").append('<option value="'+a.timezoneList[b]+'">'+a.timezoneList[b]+" ("+moment.tz(a.timezoneList[b]).format("Z")+")</option>");$("#ucsetup_timezoneinput").select2()},this.toggleTabs=function(){$("."+$(this).attr("data-tabgroup-class")).hide(),$("#"+$(this).attr("data-tabgroup-tabid")).show(),$(this).closest(".btn-group").find(".btn").removeClass("active"),$(this).addClass("active")}}function UC_AppController(){var a=this;this.apps=[],this.currentAppId=null,this.rivetAppNameObj=null,this.rivetAppListObj=null,this.renderVisitors=!1,this.constructor=function(){this.bindUIEvents(),a.initRivetBinds(),$(document).on("click","#uc_app_list li",function(){for(var b=$(this).attr("data-appid"),c=0;c<a.apps.length;c++)if(b==a.apps[c]._id){a.switchApp(a.apps[c],!1);break}}),$(document).on("click","#ucAppGenerateTrackjs",a.regenerateTrackjs)},this.initRivetBinds=function(){a.rivetAppNameObj=rivets.bind(document.querySelector("#uc_currentapp_name"),{currentAppName:a.currentAppId})},this.bindUIEvents=function(){$(document).on("click","#uc_create_newapp_modalopen_btn",function(){$("#uc_newapp_creation_modal").modal("show"),$("#uc_create_newapp_submitbtn").button("reset")}),$("#uc_create_newapp_submitbtn").on("click",function(b){b.preventDefault(),a.createNewApp()}),$("#ucupdate_app_submitbtn").on("click",function(b){b.preventDefault(),b.stopImmediatePropagation(),a.updateAppDetails()}),a.getAllUserApps()},this.getAllUserApps=function(){UC_AJAX.call("AppManager/getAllUserApps",{user:UC_UserSession.user},function(b,c,d){"failure"==b.status?alert("An Error accured while fetching user's app !"):"authenticationfailed"==b.status?location.href="/":b.status.length>0&&(a.apps=b.status,a.listApps(a.apps),a.switchApp(a.apps[0],!0))})},this.createNewApp=function(){var b=$("#uc_create_newapp_nameinput").val(),c=a.validateAppInputDetails();if(""==c){var d=new UC_App,e=UC_UserSession.user;d.name=b,d.creator=e.username,d._id=UC_Utils.guidGenerator(),d.clientId=e.company,$("#uc_create_newapp_submitbtn").button("loading"),UC_AJAX.call("AppManager/createNewApp",{newApp:d,user:e},function(b,c,d){"appexists"==b.status?alert("App with this name already exists !"):"failure"==b.status?alert("An Error accured while saving data !"):"authenticationfailed"==b.status?location.href="/":(a.apps.push(b.status),a.listApps(a.apps),$("#uc_newapp_creation_modal").modal("hide"),a.switchApp(a.apps[0],!1)),$("#uc_create_newapp_submitbtn").button("reset")})}else alert(c)},this.listApps=function(b){var c={appList:b};null==a.rivetAppListObj?a.rivetAppListObj=rivets.bind(document.querySelector("#uc_app_list"),{list:c}):a.rivetAppListObj.models.list=c,a.bindAppDetailModificationOperationEvents()},this.bindAppDetailModificationOperationEvents=function(){$(".ucapp_editbtncls").on("click",function(b){b.stopImmediatePropagation(),$("#ucapp_update_modal").modal("show");var c=$(this).attr("data-appid");a.fillAppInformationInUpdateModal(c),$("#ucupdate_app_submitbtn").button("reset")}),$("#ucDeleteAppBtn").on("click",function(b){b.stopImmediatePropagation();var c=$(this).attr("data-appid");a.deleteAnApp(c)})},this.updateAppDetails=function(){var b=$("#ucapp_update_appid").val(),c=$("#ucapp_update_nameinput").val(),d=UC_Utils.searchObjArray(a.apps,"_id",b);if(-1!=d){var e=a.apps[d];e.name=c,$("#ucupdate_app_submitbtn").button("loading"),UC_AJAX.call("AppManager/updateAnAppDetails",{app:e},function(b,c,d){"appexists"==b.status?alert("App with this name already exists !"):"failure"==b.status?alert("An Error accured while saving data !"):"authenticationfailed"==b.status?location.href="/":(a.updateAppDetailsInAppsListing(e),a.currentAppId==e._id&&(a.rivetAppNameObj.models.currentAppName=e.name),$("#ucapp_update_modal").modal("hide")),$("#ucupdate_app_submitbtn").button("reset")})}},this.deleteAnApp=function(b){if(a.apps.length>1){var c=UC_Utils.searchObjArray(a.apps,"_id",b),d=a.apps[c];confirm("Do you want to delete "+d.name+" and all its contents?")&&d&&UC_AJAX.call("AppManager/deleteAnApp",{app:d},function(b,d,e){"failure"==b.status?alert("An Error accured while deleting the app entry !"):"authenticationfailed"==b.status?location.href="/":"defaultapp"==b.status?alert("There should be a minimum of one app."):($("#ucapp_update_modal").modal("hide"),a.apps.splice(c,1),a.listApps(a.apps),a.switchApp(a.apps[0],!1))})}else alert("There should be a minimum of one app.")},this.deleteAnAppEntryFromListing=function(a){a&&$("#app_"+a).remove()},this.updateAppDetailsInAppsListing=function(a){a&&$("#app_"+a._id).find(".ucapp_namecls").html(a.name)},this.fillAppInformationInUpdateModal=function(b){if(b){var c=UC_Utils.searchObjArray(a.apps,"_id",b);if(-1!=c){var d=a.apps[c];$("#ucapp_update_nameinput").val(d.name),$("#ucapp_update_appid").val(d._id),$("#ucapp_update_appid_display").text(d._id),$("#ucDeleteAppBtn,#ucAppGenerateTrackjs").attr("data-appid",d._id);var e='<script type="text/javascript" src="'+uc_main.userController.config.baseURL+"/tracking/track.js?appid="+d._id+'"><\/script>\n<script>\n\ttry {\n\t\tUsercom.init({\n\t\t\tname: "John Smith",   /* Fullname of the visitor */\n\t\t\temail: "jsmith@usercom.io",   /* Email Address of the visitor */\n\t\t\tcreated_at: new Date().getTime(), /* Current timestamp */\n\t\t\tpaid: true, /* Boolean */\n\t\t\tbirthdate: "1990-01-01", /* Date in format YYYY-MM-DD */\n\t\t\tgender: "male", /* possible values ("male","female","other") */\n\t\t\tprofilepicture: "", /* a valid profile picture url */\n\t\t});\n\t}catch(error){console.log(error);}\n<\/script>\n';$("#ucapp_update_trackingcode").text(e)}}},this.validateAppInputDetails=function(){var a=$("#uc_create_newapp_nameinput").val(),b="";return""==a&&(b="Invalid App Name !"),b},this.add=function(){err()},this.switchApp=function(b,c){if(a.currentAppId=b._id,a.rivetAppNameObj.models.currentAppName=b.name,UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(a.currentAppId)&&UC_UserSession.user.app[a.currentAppId].hasOwnProperty("currentFilter")&&(uc_main.visitorListController.currentFilterId=UC_UserSession.user.app[a.currentAppId].currentFilter),UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(a.currentAppId)&&UC_UserSession.user.app[a.currentAppId].hasOwnProperty("filterOrder")&&UC_UserSession.user.app[a.currentAppId].filterOrder.hasOwnProperty(uc_main.visitorListController.currentFilterId)&&UC_UserSession.user.app[a.currentAppId].filterOrder[uc_main.visitorListController.currentFilterId].hasOwnProperty("currentSortColumn")&&(uc_main.visitorListController.currentSortColumn=UC_UserSession.user.app[a.currentAppId].filterOrder[uc_main.visitorListController.currentFilterId].currentSortColumn,uc_main.visitorListController.currentSortOrder=UC_UserSession.user.app[a.currentAppId].filterOrder[uc_main.visitorListController.currentFilterId].currentSortOrder),UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(a.currentAppId)&&UC_UserSession.user.app[a.currentAppId].hasOwnProperty("filterOrder")&&UC_UserSession.user.app[a.currentAppId].filterOrder.hasOwnProperty(uc_main.visitorListController.currentFilterId)&&UC_UserSession.user.app[a.currentAppId].filterOrder[uc_main.visitorListController.currentFilterId].hasOwnProperty("displayFields")&&(uc_main.visitorListController.displayFields=UC_UserSession.user.app[a.currentAppId].filterOrder[uc_main.visitorListController.currentFilterId].displayFields),a.renderVisitors?(uc_main.dashboardController.getDashboardMetrics(),uc_main.dashboardController.drawNewUsersGraph(),uc_main.filterController.listUserdefinedFilters(),uc_main.visitorListController.getFieldsList()):c||(location.href="/"),uc_main.rtcController.socket){var d={};d.name="establishappconnection",d.key=a.currentAppId,d=JSON.stringify(d),uc_main.rtcController.sendMessageToServer(d)}var e=window.location.pathname.split("/");3==e.length&&"visitor"==e[1]&&(uc_main.visitorListController.getVisitorDetails(e[2]),$(".ucVisitorPageWrapper").show(),$(".ucIndexPageWrapper").hide())},this.regenerateTrackjs=function(){var a=$(this).attr("data-appid");$("#ucAppGenerateTrackjs").button("loading"),UC_AJAX.call("AppManager/regeneratetrackjs",{user:UC_UserSession.user,appId:a},function(a,b,c){
"failure"==a.status?alert("An Error accured while generating trackjs"):"authenticationfailed"==a.status?location.href="/":alert("Trackjs re-generated successfully"),$("#ucAppGenerateTrackjs").button("reset")})}}function UC_AJAXController(){var a=this;a.baseUrl="",this.get=function(b,c){var d=a.getUrl(b.endpoint);$.get(d).done(function(a,b,d){c(a,b,d)}).fail(function(b){a.ajaxError(b)})},this.post=function(b,c){var d=a.getUrl(b.endpoint);$.ajax({url:d,type:"POST",data:b.data,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a,b,d){c(a,b,d)}).fail(function(b){a.ajaxError(b)})},this.getUrl=function(b){var c=a.baseUrl;return b&&(c=c+"/"+b),c},this.call=function(b,c,d){var e={endpoint:b,data:JSON.stringify(c)};a.post(e,d)},this.ajaxError=function(a){alert("An Error accured !")}}function UC_User(){this._id="",this.firstName="",this.lastName="",this.createDate=null,this.username="",this.password="",this.company="",this.app={},this.token=null,this.cast=function(a){this._id=a._id,this.firstName=a.firstName,this.lastName=a.lastName,this.createDate=new Date(a.createDate),this.username=a.username,this.password=a.password,this.company=a.company,this.app=a.app,this.token=a.token}}function UC_App(){this._id="",this.name="",this.clientId="",this.createDate=null,this.creator="",this.cast=function(a){this._id=a._id,this.name=a.name,this.clientId=a.clientId,this.createDate=new Date(a.createDate),this.creator=a.creator}}function UC_Filter(){this._id=null,this.name="",this.filter=null,this.mongoFilter=null,this.createDate=null,this.creator=null,this.clientId=null,this.appId=null,this.cast=function(a){this._id=a._id,this.name=a.name,this.filter=mongofilter,this.mongoFilter=a.mongoFilter,this.createDate=new Date(a.createDate),this.creator=a.createDate,this.clientId=a.clientId,this.appId=a.appId}}function UC_Visitor(){this._id=null,this.appid=null,this.visitorData={name:"",email:"",created_at:null},this.visitorMetaInfo={firstSeen:null,lastSeen:null}}function UC_VisitorSession(){this._id=null,this.visitorId=null,this.agentInfo={browser:"",browserLanguage:"",os:"",platform:"",version:null},this.visitorMetaInfo={firstSeen:null,lastSeen:null}}function UC_DashboardController(){var a=this;this.metrics={},this.constructor=function(){},this.getDashboardMetrics=function(){uc_main.appController.currentAppId&&($("#ucDashboardMetricsContainer").hide(),UC_AJAX.call("DashboardManager/metrics",{appid:uc_main.appController.currentAppId},function(b,c,d){"failure"==b.status?alert("An Error accured while fetching visitors list !"):"authenticationfailed"==b.status?location.href="/":(a.metrics=b.metrics,a.listMetrics()),$("#ucDashboardMetricsContainer").show()}))},this.listMetrics=function(){rivets.binders.faiconclass=function(a,b){a.className="fa fa-"+b.toLowerCase()},rivets.bind(document.querySelector("#uc_tab_data_dashboard"),{currentUsers:10,totalUsers:a.metrics.totalUsers,slippingAway:a.metrics.slippingAway,topBrowser:"Chrome",newUsers:a.metrics.newUsers,openIssues:10})},this.drawNewUsersGraph=function(){if(uc_main.appController.currentAppId){$("#ucNewUsersGraph").hide(),UC_AJAX.call("DashboardManager/newusers",{appid:uc_main.appController.currentAppId,days:30},function(a,b,c){if("failure"==a.status)alert("An Error accured while fetching visitors list !");else if("authenticationfailed"==a.status)location.href="/";else{for(var d=a.status,e=[],f=[],g=new Date(new Date-2592e6),h=g,i=0;i<30;i++){h=new Date(h.getTime()+864e5);var j=h.getMonth()+1+"";j=1==j.length?"0"+j:j;var k=h.getDate()+"";k=1==k.length?"0"+k:k,e[i]=k+"-"+j,f[i]=0;for(var l=0;l<d.length;l++)if(d[l].date==k+"-"+j){f[i]=d[l].visitors;break}}var a={labels:e,datasets:[{label:"New Users",fill:!1,lineTension:.1,backgroundColor:"rgba(75,192,192,0.4)",borderColor:"rgba(75,192,192,1)",borderCapStyle:"round",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",pointBorderColor:"rgba(75,192,192,1)",pointBackgroundColor:"#fff",pointBorderWidth:1,pointHoverRadius:5,pointHoverBackgroundColor:"rgba(75,192,192,1)",pointHoverBorderColor:"rgba(220,220,220,1)",pointHoverBorderWidth:2,pointRadius:4,pointHitRadius:10,data:f,spanGaps:!1}]};new Chart($("#ucNewUsersGraph"),{type:"line",data:a})}$("#ucNewUsersGraph").show()})}}}function UC_FilterController(){var a=this;this.predefinedFiltersList=[],this.userdefinedFiltersList=[],this.rivetPredefinedFiltersListObj=null,this.rivetUserdefinedFiltersListObj=null,this.filterOnEdit=null,this.constructor=function(){uc_main.appController.renderVisitors&&(a.listPredefinedFilters(),$(document).on("click","#ucPredefinedFilterList li, #ucUserdefinedFilterList li",a.changeFilterHandler),$(document).on("click",".ucAddFilterBtn",a.addFilterHandler),$(document).on("click","#ucEditFilterSubmit",a.saveFilterHandler),$(document).on("click","#ucEditFilterDraftBtn",a.draftFilterHandler),$(document).on("click",".ucFilterSettingBtn .ucFilterListEditBtn",a.editFilterHandler),$(document).on("click",".ucFilterSettingBtn .ucFilterListDeleteBtn",a.deleteFilterHandler),$("#ucUserdefinedFilterList").sortable({update:a.updateFilterOrder}),$(document).on("click","#ucMainDashboard",function(){a.changeCurrentFilter("dashboard")}))},this.initRivetBinds=function(){a.rivetPredefinedFiltersListObj=rivets.bind(document.querySelector("#ucPredefinedFilterList"),{list:a.predefinedFiltersList}),a.rivetUserdefinedFiltersListObj=rivets.bind(document.querySelector("#ucUserdefinedFilterList"),{list:a.userdefinedFiltersList})},this.listPredefinedFilters=function(){UC_AJAX.call("FilterManager/listpredefined",{user:UC_UserSession.user},function(b,c,d){"failure"==b.status?alert("An Error accured while fetching filters list"):"authenticationfailed"==b.status?location.href="/":(a.predefinedFiltersList=b.status,a.rivetPredefinedFiltersListObj.models.list=a.predefinedFiltersList)})},this.listUserdefinedFilters=function(){a.rivetUserdefinedFiltersListObj.models.list=[],UC_AJAX.call("FilterManager/listuserdefined",{user:UC_UserSession.user,appid:uc_main.appController.currentAppId},function(b,c,d){if("failure"==b.status)alert("An Error accured while fetching filters list");else if("authenticationfailed"==b.status)location.href="/";else{var e=UC_UserSession.user,f=b.status;if(e.hasOwnProperty("app")&&e.app.hasOwnProperty(uc_main.appController.currentAppId)&&e.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")){var g=e.app[uc_main.appController.currentAppId].filterOrder,h=[];for(var i in g)for(var j=0;j<f.length;j++)i==f[j]._id&&h.push(f[j]);f=h}a.userdefinedFiltersList=f,a.rivetUserdefinedFiltersListObj.models.list=a.userdefinedFiltersList,"dashboard"==uc_main.visitorListController.currentFilterId?($(".ucSwitchContentContainer").hide(),$("#uc_tab_data_dashboard").show(),$(".ucSwitchContentTrigger").removeClass("ucCurrentPage"),$("#ucMainDashboard").addClass("ucCurrentPage")):($(".ucSwitchContentContainer").hide(),$("#uc_tab_data_listuser").show(),$(".ucSwitchContentTrigger").removeClass("ucCurrentPage"),$("#ucPredefinedFilterList li[data-filterid="+uc_main.visitorListController.currentFilterId+"],#ucUserdefinedFilterList li[data-filterid="+uc_main.visitorListController.currentFilterId+"]").addClass("ucCurrentPage"))}})},this.initQueryBuilder=function(a){$("#ucFilterQueryBuilderUI").queryBuilder("destroy"),$("#ucFilterQueryBuilderUI").queryBuilder({plugins:["bt-tooltip-errors"],filters:[{id:"visitorData.name",label:"Name",type:"string"},{id:"visitorMetaInfo.lastSeen",label:"Last Seen",type:"datetime",validation:{format:"YYYY-MM-DD HH:mm:ss"},plugin:"datetimepicker",plugin_config:{format:"Y-m-d H:i:s"},input:"text",operators:["less_or_equal","greater_or_equal","between"]},{id:"sessions.agentInfo.browser",label:"Browser",type:"string"},{id:"sessions.agentInfo.os",label:"Operatig System",type:"string"},{id:"sessions.agentInfo.device",label:"Device",type:"string"},{id:"sessions.geoLocationInfo.country",label:"Country Code",type:"string"},{id:"sessions.geoLocationInfo.countryName",label:"Country Name",type:"string"}],rules:a})},this.editFilterHandler=function(){var b=a.getFilterById($(this).closest(".ucSwitchContentTrigger").attr("data-filterid"));a.filterOnEdit=b,a.initQueryBuilder(JSON.parse(b.filter)),$("#ucFilterName").val(b.name),$("#ucEditFilterModal").modal(),$("#ucUpdateFilterAjaxLoader").hide(),$(".rule-container .rule-actions .btn-danger").text(""),$(".rule-container .rule-actions .btn-danger").addClass("ucListingFilterDeleteIcon"),$("#ucFilterQueryBuilderUI").on("afterAddRule.queryBuilder",function(a,b,c,d){$(".rule-container .rule-actions .btn-danger").text(""),$(".rule-container .rule-actions .btn-danger").addClass("ucListingFilterDeleteIcon")})},this.getFilterById=function(b){for(var c=0;c<a.userdefinedFiltersList.length;c++){var d=a.userdefinedFiltersList[c];if(d._id==b)return d}return!1},this.addFilterHandler=function(){a.filterOnEdit=null,a.initQueryBuilder(null),$("#ucFilterName").val(""),$("#ucEditFilterModal").modal(),$("#ucUpdateFilterAjaxLoader").hide(),$(".rule-container .rule-actions .btn-danger").text(""),$(".rule-container .rule-actions .btn-danger").addClass("ucListingFilterDeleteIcon"),$("#ucFilterQueryBuilderUI").on("afterAddRule.queryBuilder",function(a,b,c,d){$(".rule-container .rule-actions .btn-danger").text(""),$(".rule-container .rule-actions .btn-danger").addClass("ucListingFilterDeleteIcon")})},this.saveFilterHandler=function(){var b=$("#ucFilterQueryBuilderUI").queryBuilder("getRules");$.isEmptyObject(b)||(b=JSON.stringify(b,null,2));var c=$("#ucFilterQueryBuilderUI").queryBuilder("getMongo");$.isEmptyObject(c)||(c=JSON.stringify(c,null,2));var d=$("#ucFilterName").val();if(""==$.trim(d))return void alert("Filter Name is Required");if(null==a.filterOnEdit){var e=new UC_Filter;e._id="F"+UC_Utils.guidGenerator(),e.creator=UC_UserSession.user._id,e.clientId=UC_UserSession.user.company,e.appId=uc_main.appController.currentAppId,e.name=d,e.filter=b,e.mongoFilter=c,a.userdefinedFiltersList.push(e),UC_UserSession.user.hasOwnProperty("app")||(UC_UserSession.user.app={}),UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)||(UC_UserSession.user.app[uc_main.appController.currentAppId]={}),UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")?UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[e._id]={currentSortColumn:"visitorMetaInfo.lastSeen",currentSortOrder:1,displayFields:["browser","os","device","country"]}:a.updateFilterOrder(),a.saveAppPreference()}else{var e=a.filterOnEdit;e.name=d,e.filter=b,e.mongoFilter=c}$("#ucUpdateFilterAjaxLoader").show(),UC_AJAX.call("FilterManager/updateFilter",{filter:e},function(b,c,d){b&&("failure"==b.status?alert("An Error accured while saving data !"):"authenticationfailed"==b.status?location.href="/":($("#ucEditFilterModal").modal("hide"),a.listUserdefinedFilters(),uc_main.visitorListController.currentFilterId==e._id&&(uc_main.visitorListController.resetPagination(),uc_main.visitorListController.getAllVisitors()))),$("#ucUpdateFilterAjaxLoader").hide()})},this.changeFilterHandler=function(){$("#uc_tab_data_dashboard").hide(),$("#uc_tab_data_listuser").show();var b=$(this).closest(".ucSwitchContentTrigger").attr("data-filterid");a.changeCurrentFilter(b),uc_main.visitorListController.resetPagination(),uc_main.visitorListController.getAllVisitors()},this.deleteFilterHandler=function(){var b=a.getFilterById($(this).closest(".ucSwitchContentTrigger").attr("data-filterid"));if(confirm("Are you sure that you want to delete the filter?")){for(var c=0;c<a.userdefinedFiltersList.length;c++){var d=a.userdefinedFiltersList[c];b._id==d._id&&(a.userdefinedFiltersList.splice(c,1),c--)}UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)&&UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")&&delete UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[b._id],uc_main.visitorListController.currentFilterId==b._id&&(a.changeCurrentFilter("1"),uc_main.visitorListController.resetPagination(),uc_main.visitorListController.getAllVisitors()),UC_AJAX.call("FilterManager/deleteFilter",{filter:b},function(b,c,d){b&&("failure"==b.status?alert("An Error accured while deleting"):"authenticationfailed"==b.status?location.href="/":a.listUserdefinedFilters())})}},this.updateFilterOrder=function(b,c){var d={};UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")&&(d=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder);var e={};$("#ucUserdefinedFilterList li").each(function(){d.hasOwnProperty($(this).attr("data-filterid"))?e[$(this).attr("data-filterid")]=d[$(this).attr("data-filterid")]:e[$(this).attr("data-filterid")]={currentSortColumn:"visitorMetaInfo.lastSeen",currentSortOrder:1,displayFields:[]}}),UC_UserSession.user.hasOwnProperty("app")||(UC_UserSession.user.app={}),UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)||(UC_UserSession.user.app[uc_main.appController.currentAppId]={}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder=e,a.saveAppPreference()},this.saveAppPreference=function(){UC_AJAX.call("UserManager/updateAppPreference",{user:UC_UserSession.user},function(a,b,c){a&&("failure"==a.status?alert("An Error accured while saving data"):"authenticationfailed"==a.status&&(location.href="/"))})},this.changeCurrentFilter=function(b){uc_main.visitorListController.currentFilterId=b,UC_UserSession.user.hasOwnProperty("app")||(UC_UserSession.user.app={}),UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)||(UC_UserSession.user.app[uc_main.appController.currentAppId]={}),UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder={}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder.hasOwnProperty(b)||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[b]={currentSortColumn:"visitorMetaInfo.lastSeen",currentSortOrder:1,displayFields:[]}),UC_UserSession.user.app[uc_main.appController.currentAppId].currentFilter=b,uc_main.visitorListController.currentSortColumn=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[b].currentSortColumn,uc_main.visitorListController.currentSortOrder=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[b].currentSortOrder,uc_main.visitorListController.displayFields=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[b].displayFields,a.saveAppPreference()},this.selectCurrentFilter=function(){$("#ucPredefinedFilterList li,#ucUserdefinedFilterList li").removeClass("ucCurrentFilter"),$("#ucPredefinedFilterList li[data-filterid='"+uc_main.visitorListController.currentFilterId+"']").addClass("ucCurrentFilter"),$("#ucUserdefinedFilterList li[data-filterid='"+uc_main.visitorListController.currentFilterId+"']").addClass("ucCurrentFilter")},this.draftFilterHandler=function(){var a=$("#ucFilterQueryBuilderUI").queryBuilder("getRules");$.isEmptyObject(a)||(a=JSON.stringify(a,null,2));var b=$("#ucFilterQueryBuilderUI").queryBuilder("getMongo");$.isEmptyObject(b)||(b=JSON.stringify(b,null,2)),$("#ucEditFilterModal").modal("hide"),uc_main.visitorListController.resetPagination(),uc_main.visitorListController.getAllVisitors(b)}}function UC_MainController(){var a=this;this.appController=new UC_AppController,this.dashboardController=new UC_DashboardController,this.visitorListController=new UC_VisitorListController,this.userController=new UC_UserController,this.filterController=new UC_FilterController,this.messagingController=new UC_MessagingController,this.rtcController=new UC_RTCController,this.rivetUserNameObj=null,this.constructor=function(){a.appController.constructor(),a.dashboardController.constructor(),a.visitorListController.constructor(),a.userController.constructor(),a.filterController.constructor(),a.messagingController.constructor(),a.rtcController.sessionID=UC_Utils.guidGenerator(),a.rtcController.connect(),a.initRivetBinds(),$(".uc_tab_trigger").on("click",a.toggleTabs),$(document).on("click",".ucSwitchContentTrigger",a.switchContent),$(".ucSwitchContentContainer").hide(),$("#ucPageLoader").show(),$("#ucMainDashboard").addClass("ucCurrentPage"),$(".ucSideBarMenuTrigger").on("click",a.menuContainer),$(".ucSidebarCloseBtn").on("click",a.closeMenuContainer),$(".mfTooltip").tooltip(),$(document).on("click",function(a){$('[data-toggle="popover"],[data-original-title]').each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})}),$(window).resize(function(){a.interfaceResize()}),a.interfaceResize()},this.initRivetBinds=function(){a.rivetUserNameObj=rivets.bind(document.querySelector("#uc_currentuser_name"),{currentUserName:UC_UserSession.user.firstName+" "+UC_UserSession.user.lastName})},this.toggleTabs=function(){$("."+$(this).attr("data-tabgroup-class")).hide(),$("#"+$(this).attr("data-tabgroup-tabid")).show(),$(this).closest(".btn-group").find(".btn").removeClass("active"),$(this).addClass("active")},this.switchContent=function(b){var c=$(this).attr("switch-to");$(".ucSwitchContentContainer").hide(),$("#"+c).show(),"uc_tab_data_dashboard"!=c&&$("#ucPageLoader").show(),$(".ucSwitchContentTrigger").removeClass("ucCurrentPage"),$(this).addClass("ucCurrentPage"),a.closeMenuContainer(b)},this.menuContainer=function(a){a.stopPropagation(),$(".ucSidebar,.ucMainContent,.ucIndexPageWrapper, body,  #ucHeader").hasClass("open")?($(".ucSidebar,.ucMainContent,.ucIndexPageWrapper, body , #ucHeader").removeClass("open"),$("html, body").css({overflow:"auto"})):($(".ucSidebar,.ucMainContent, .ucIndexPageWrapper, body , #ucHeader").addClass("open"),$("html, body").css({overflow:"hidden"}))},this.closeMenuContainer=function(a){a.stopPropagation(),$(".ucSidebar,.ucMainContent,.ucIndexPageWrapper, body , #ucHeader").removeClass("open"),$("html, body").css({overflow:"auto"})},this.interfaceResize=function(){1==$(".ucSidebar").length&&$(".ucSidebar").height($(window).height()-$(".ucSidebar").offset().top-30);var a=0;"block"==$(".ucSidebar").css("display")&&(a=$(".ucSidebar").width()+40),$(".ucTableWrapper").height($(window).height()-195),$(".ucTableWrapper").width($(window).width()-a-20)}}function UC_BrowserNotificationController(){var a=this;this.rivetBrowserNotificationTemplateListObj=null,this.browserNotificationTemplateList=[],this.constructor=function(){$(document).on("click","#ucSendMessageBrowserNotificationSubmit",a.submitBrowserNotificationMessageHandler),$(document).on("change","#ucSendMessageBrowserNotificationTemplate",a.templateChangeHandler),$(document).on("click","#ucDeleteBrowserNotificationTemplateBtn",a.deleteTemplateHandler),a.rivetBrowserNotificationTemplateListObj=rivets.bind(document.querySelector("#ucSendMessageBrowserNotificationTemplate"),{browserNotificationTemplateList:a.browserNotificationTemplateList})},this.getBrowserNotificationTemplates=function(){UC_AJAX.call("BrowserNotificationManager/getbrowsernotificationtemplates",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user},function(b,c,d){"failure"==b.status?alert("Could not get browser notifications templates, please try again later"):"authenticationfailed"==b.status?location.href="/":(a.browserNotificationTemplateList=b.browserNotificationTemplateList,a.rivetBrowserNotificationTemplateListObj.models.browserNotificationTemplateList=a.browserNotificationTemplateList,$("#ucSendMessageBrowserNotificationTemplate option:eq(0)").prop("selected",!0),$("#ucSendMessageBrowserNotificationTitle,#ucSendMessageBrowserNotificationLink,#ucSendMessageBrowserNotificationBody").val(""))})},this.submitBrowserNotificationMessageHandler=function(b){b.preventDefault();var c=$("#ucSendMessageBrowserNotificationTitle").val(),d=$("#ucSendMessageBrowserNotificationLink").val(),e=$("#ucSendMessageBrowserNotificationBody").val(),f=$("#ucSendMessageBrowserNotificationTemplate").val(),g=!1;$("#ucSendMessageBrowserNotificationBlockDuplicate").is(":checked")&&(g=!0);var h=a.validateSendMessageBrowserNotificationInputs();if("failure"==h.status)return void alert(h.msg);uc_main.messagingController.sendMessageHandler(c,e,f,d,g,"browsernotification","","")},this.templateChangeHandler=function(){"new"==$(this).val()?($("#ucSendMessageBrowserNotificationTitle,#ucSendMessageBrowserNotificationLink,#ucSendMessageBrowserNotificationBody").val(""),$("#ucDeleteBrowserNotificationTemplateBtn").hide(),$("#ucSendMessageBrowserNotificationTemplate").removeClass("ucExistTemplate")):($("#ucSendMessageBrowserNotificationTitle").val($(this).find("option:selected").text()),$("#ucSendMessageBrowserNotificationLink").val($(this).find("option:selected").attr("data-templatelink")),$("#ucSendMessageBrowserNotificationBody").val($(this).find("option:selected").attr("data-templatebody")),$("#ucDeleteBrowserNotificationTemplateBtn").show(),$("#ucSendMessageBrowserNotificationTemplate").addClass("ucExistTemplate"))},this.deleteTemplateHandler=function(){var a=$("#ucSendMessageBrowserNotificationTemplate").val();"new"!=a&&confirm("Are you sure you want to delete the template?")&&($("#ucBrowserNotificationTemplateDeleteAjaxLoader").show(),$("#ucDeleteBrowserNotificationTemplateBtn").hide(),UC_AJAX.call("BrowserNotificationManager/deletetemplate",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user,templateId:a},function(a,b,c){"failure"==a.status?alert("Could not delete template"):"authenticationfailed"==a.status?location.href="/":$("#ucSendMessageModal").modal("hide"),$("#ucBrowserNotificationTemplateDeleteAjaxLoader").hide(),$("#ucDeleteBrowserNotificationTemplateBtn").show()}))},this.validateSendMessageBrowserNotificationInputs=function(){var a={status:"success",msg:""},b=$("#ucSendMessageBrowserNotificationTitle").val(),c=$("#ucSendMessageBrowserNotificationLink").val(),d=$("#ucSendMessageBrowserNotificationBody").val(),e="";return""==$.trim(b)?e="Subject is required":""==$.trim(c)?e="Link is required":""==$.trim(d)&&(e="Message is required"),""!=e&&(a.status="failure",a.msg=e),a}}function UC_EmailMessagingController(){var a=this;this.rivetEmailTemplateListObj=null,this.emailTemplateList=[],this.sendtype="now",this.constructor=function(){$(document).on("click","#ucSendMessageEmailSubmit",a.submitEmailMessageHandler),$(document).on("change","#ucSendMessageEmailTemplate",a.templateChangeHandler),$(document).on("click","#ucDeleteEmailTemplateBtn",a.deleteTemplateHandler),a.rivetEmailTemplateListObj=rivets.bind(document.querySelector("#ucSendMessageEmailTemplate"),{emailTemplateList:a.emailTemplateList});var b=new Date;b.setDate(b.getDate()+30),$("#ucSendMessageEmailScheduleDatetime").datetimepicker({minDate:new Date,maxDate:b,step:5,format:"Y-m-d H:i"}),$(".ucSendMessageEmailSendTypeItem").click(function(){a.sendtype=$(this).attr("data-sendtype"),"later"==$(this).attr("data-sendtype")?($("#ucSendMessageEmailScheduleContainer").show(),$("#ucSendMessageEmailSubmit").text("Send Later")):($("#ucSendMessageEmailScheduleContainer").hide(),$("#ucSendMessageEmailSubmit").text("Send Now")),$(".ucSendMessageEmailSendTypeItem").show(),$(this).hide()})},this.getEmailTemplates=function(){UC_AJAX.call("EmailManager/getemailtemplates",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user},function(b,c,d){"failure"==b.status?alert("Could not get email templates, please try again later"):"authenticationfailed"==b.status?location.href="/":(a.emailTemplateList=b.emailTemplateList,a.rivetEmailTemplateListObj.models.emailTemplateList=a.emailTemplateList,$("#ucSendMessageEmailTemplate option:eq(0)").prop("selected",!0),$("#ucSendMessageEmailSubject").val(""),uc_main.messagingController.quill.setText(""))})},this.submitEmailMessageHandler=function(b){b.preventDefault();var c,d=$("#ucSendMessageEmailSubject").val();c=1==$("#ucEditorTogglebtn").prop("checked")?uc_main.messagingController.quill.container.firstChild.innerHTML:$("#ucSendMessageCodeEditor").val();var e=$("#ucSendMessageEmailTemplate").val(),f=$("#ucSendMessageEmailScheduleDatetime").val(),g=!1;$("#ucSendMessageEmailBlockDuplicate").is(":checked")&&(g=!0);var h=a.validateSendMessageEmailInputs();if("failure"==h.status)return void alert(h.msg);uc_main.messagingController.sendMessageHandler(d,c,e,"",g,"email",a.sendtype,f)},this.templateChangeHandler=function(){"new"==$(this).val()||"noTemplate"==$(this).val()?($("#ucSendMessageEmailSubject").val(""),uc_main.messagingController.quill.setText(""),$("#ucSendMessageCodeEditor").val(""),$("#ucDeleteEmailTemplateBtn").hide(),$("#ucSendMessageEmailTemplate").removeClass("ucExistTemplate")):($("#ucSendMessageEmailSubject").val($(this).find("option:selected").text()),uc_main.messagingController.quill.container.firstChild.innerHTML=$(this).find("option:selected").attr("data-templatebody"),$("#ucSendMessageCodeEditor").val($(this).find("option:selected").attr("data-templatebody")),$("#ucDeleteEmailTemplateBtn").show(),$("#ucSendMessageEmailTemplate").addClass("ucExistTemplate"))},this.deleteTemplateHandler=function(){var a=$("#ucSendMessageEmailTemplate").val();"new"!=a&&"noTemplate"!=a&&confirm("Are you sure you want to delete the template?")&&($("#ucEmailTemplateDeleteAjaxLoader").show(),$("#ucDeleteEmailTemplateBtn").hide(),UC_AJAX.call("EmailManager/deletetemplate",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user,templateId:a},function(a,b,c){"failure"==a.status?alert("Could not delete template"):"authenticationfailed"==a.status?location.href="/":$("#ucSendMessageModal").modal("hide"),$("#ucDeleteEmailTemplateBtn").show(),$("#ucEmailTemplateDeleteAjaxLoader").hide()}))},this.validateSendMessageEmailInputs=function(){var b,c={status:"success",msg:""},d=$("#ucSendMessageEmailSubject").val(),e=$("#ucSendMessageEmailScheduleDatetime").val(),f="";return b=1==$("#ucEditorTogglebtn").prop("checked")?uc_main.messagingController.quill.getText():$("#ucSendMessageCodeEditor").val(),""==$.trim(d)?f="Subject is required":""==$.trim(b)&&(f="Message is required"),"later"==a.sendtype&&""==$.trim(e)&&(f="Schedule Date and Time required"),""!=f&&(c.status="failure",c.msg=f),c},this.initSendTypeSettings=function(){a.sendtype="now",$("#ucSendMessageEmailScheduleContainer").hide(),$("#ucSendMessageEmailSubmit").text("Send Now"),$(".ucSendMessageEmailSendTypeItem").show(),$(".ucSendMessageEmailSendTypeItem[data-sendtype=now]").hide()}}function UC_MessagingController(){var a=this;this.emailMessagingController=new UC_EmailMessagingController,this.browserNotificationController=new UC_BrowserNotificationController,this.rivetFieldListObj=null,this.quill=null,this.constructor=function(){a.emailMessagingController.constructor(),a.browserNotificationController.constructor(),$(document).on("click","#ucSendMessageGroupBtn",a.openSendMessageModal),$(document).on("click",".ucSendMessageSingleTrigger",a.selectCurrentVisitor),$("#ucEditorTogglebtn").on("change",a.editorToggleHandler),a.rivetFieldListObj=rivets.bind(document.querySelector("#ucEmailFieldList"),{fieldList:[]});var b=["#F44336","#FF5722","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#795548","#9E9E9E","#607D8B","#FFFFFF","#000000","#212121","#424242","#616161","#757575","#9E9E9E","#BDBDBD","#E0E0E0","#EEEEEE","#F5F5F5","#FAFAFA"],c=[["bold","italic","underline","image"],["link"],[{color:b},{background:b}],[{font:[]},{size:["small",!1,"large","huge"]}]];a.quill=new Quill("#ucSendMessageEmailBody",{theme:"snow",modules:{toolbar:c}}),a.quill.getModule("toolbar").addHandler("image",a.imagelinkHandler)},this.imagelinkHandler=function(){var a=this.quill.getSelection(),b=prompt("Paste the image URL");null!=b&&this.quill.insertEmbed(a.index,"image",b,Quill.sources.USER)},this.openSendMessageModal=function(){$("#ucSendMessageModal").modal(),$("#ucEmailTemplateDeleteAjaxLoader,#ucBrowserNotificationTemplateDeleteAjaxLoader").hide(),$("#ucSendMessageEmailSubmit").button("reset"),$("#ucSendMessageBrowserNotificationSubmit").button("reset"),$("#ucDeleteEmailTemplateBtn, #ucDeleteBrowserNotificationTemplateBtn").hide(),$("#ucSendMessageEmailTemplate, #ucSendMessageBrowserNotificationTemplate").removeClass("ucExistTemplate"),$(".ucSendMessageContainer").hide(),$("#ucSendMessageEmailContainer").show(),$("#ucSendMessageTypeTabGroup button").removeClass("active"),$("#ucSendMessageTypeTabGroup button[data-tabgroup-tabid=ucSendMessageEmailContainer]").addClass("active"),a.quill.setText(""),$("#ucSendMessageCodeEditor").val(""),a.emailMessagingController.initSendTypeSettings(),a.emailMessagingController.getEmailTemplates(),a.browserNotificationController.getBrowserNotificationTemplates(),UC_AJAX.call("VisitorListManager/getfieldslist",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user},function(b,c,d){if("failure"==b.status)alert("Error while getting field list");else if("authenticationfailed"==b.status)location.href="/";else{for(var e=0;e<b.fields.length;e++)b.fields[e]="{"+b.fields[e]+"}";a.rivetFieldListObj.models.fieldList=b.fields}})},this.selectCurrentVisitor=function(){$("#uc-all-user-select").prop("checked",!1),$(".uc-user-select").prop("checked",!1),uc_main.visitorListController.userListSelectHandler(),$(this).closest(".ucTableRow").find(".uc-user-select").prop("checked",!0),a.openSendMessageModal()},this.sendMessageHandler=function(a,b,c,d,e,f,g,h){var i=null,j=[],k=[];$("#uc-all-user-select").is(":checked")?(i=uc_main.visitorListController.currentFilterId,$(".uc-user-select").each(function(){$(this).is(":checked")||j.push($(this).attr("data-visitorid"))})):$(".uc-user-select").each(function(){$(this).is(":checked")&&k.push($(this).attr("data-visitorid"))}),$("#ucSendMessageEmailSubmit").button("loading"),$("#ucSendMessageEmailSubmit").next(".dropdown-toggle").attr("disabled",!0),$("#ucSendMessageBrowserNotificationSubmit").button("loading"),UC_AJAX.call("MessagingManager/sendmessage",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user,filterId:i,exclusionList:j,inclusionList:k,subject:a,message:b,template:c,link:d,blockDuplicate:e,messageType:f,sendType:g,scheduleDatetime:h},function(a,b,c){"failure"==a.status?alert("Could not send messages, kindly check the "+f+" Settings"):"authenticationfailed"==a.status?location.href="/":$("#ucSendMessageModal").modal("hide"),$("#ucSendMessageEmailSubmit").button("reset"),$("#ucSendMessageEmailSubmit").next(".dropdown-toggle").attr("disabled",!1),$("#ucSendMessageBrowserNotificationSubmit").button("reset")})},this.editorToggleHandler=function(){if($("#ucSendMessageEmailBodyWrapper,#ucSendMessageCodeEditor").hide(),1==$(this).prop("checked")){confirm("Switching to Editor will modify the HTML layout. Click OK to proceed")?(a.quill.setText(""),a.quill.clipboard.dangerouslyPasteHTML($("#ucSendMessageCodeEditor").val()),$("#ucSendMessageEmailBodyWrapper").show()):($(this).prop("checked",!1),$("#ucSendMessageCodeEditor").show())}else $("#ucSendMessageCodeEditor").show().val(uc_main.messagingController.quill.container.firstChild.innerHTML.replace("<p><br></p>",""))}}function UC_RTCController(){var a=this;this.socket=null,this.ONLINE=!1,this.sessionID=null,this.connect=function(){var b="ws",c="8001";"https:"==location.protocol&&(b="wss",c="8002"),a.socket=new WebSocket(b+"://"+location.hostname+":"+c+"/echo"),a.socket.onopen=function(){a.ONLINE=a.socket.readyState;var b={};b.name="establishappconnection",b.key=uc_main.appController.currentAppId,b=JSON.stringify(b),a.socket.send(b)},a.socket.onmessage=function(b){var c=JSON.parse(b.data);c&&"object"==typeof c&&a.peerRTC(c)}},this.peerRTC=function(a){if("newvisitor"===a.name&&a.reciever==uc_main.appController.currentAppId&&uc_main.visitorListController.newVisitorAction(a),
"visitorjoined"===a.name){var b=a.visitorKey.split("-")[0],c=a.visitorKey.split("-")[1];if(c==uc_main.appController.currentAppId){var d=$.grep(uc_main.visitorListController.visitors,function(a){return a.visitorData.email==b});d[0].isVisitorOffline=!1,d[0].isVisitorOnline=!0}}if("visitordisconnected"===a.name){var b=a.visitorKey.split("-")[0],c=a.visitorKey.split("-")[1];if(c==uc_main.appController.currentAppId){var d=$.grep(uc_main.visitorListController.visitors,function(a){return a.visitorData.email==b});d[0].isVisitorOffline=!0,d[0].isVisitorOnline=!1}}},this.sendMessageToServer=function(b){try{a.ONLINE&&a.socket.send(b)}catch(a){console.log(a)}}}function browserNotification(){try{navigator.serviceWorker.register(DEFAULT_CONFIG.serviceWorkerFile).then(function(a){return a.pushManager.getSubscription().then(function(b){return b||a.pushManager.subscribe({userVisibleOnly:!0})})}).then(function(a){fetch(DEFAULT_CONFIG.api_baseurl+"/VisitorTrackingManager/register",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify({sessionId:usercomlib.sessionId,endpoint:a.endpoint,p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(a.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(a.getKey("auth"))))})})}).catch(function(a){console.log(a)})}catch(a){console.log(a)}}function trackEvent(){window.usercomlib.trackEvent=function(a,b){var c=this;if(!a||0==a.length)return void console.error("Usercom Error: Event name not provided !");var d={appid:c.appid,userdata:c.userData,properties:b,eventname:a,sessionId:c.sessionId,visitorId:c.visitorId};xhr.raw(DEFAULT_CONFIG.api_baseurl+"/VisitorTrackingManager/event",JSON.stringify(d),function(a){})}}function UC_VisitorListController(){var a=this;this.visitors=[],this.activities=[],this.visitorId=null,this.visitorListPageLimit=30,this.visitorListSkipIndex=0,this.visitorListLoaded=!1,this.rivetVisitorListObj=null,this.rivetVisitorDetailsObj=null,this.rivetVisitorMessagesObj=null,this.rivetVisitorSessionsObj=null,this.rivetVisitorPlaceholderObj=null,this.activityListSkipIndex=0,this.activityListPageLimit=30,this.activityListloaded=!1,this.rivetVisitorColumnListObj=null,this.currentFilterId="dashboard",this.currentSortColumn="visitorMetaInfo.lastSeen",this.currentSortOrder=-1,this.currentFilterTotalVisitors=0,this.newVisitors=0,this.displayFields=[],this.visitorListInProcess=!1,this.constructor=function(){uc_main.appController.renderVisitors&&($(".ucTableWrapper").scroll(function(){$(".ucTableWrapper").offset().top-$("#uc_visitor_list").offset().top==$("#uc_visitor_list").height()-$(".ucTableWrapper").height()+1&&(a.visitorListLoaded||a.getAllVisitors())}),$(document).on("click",".ucUserListSortableColumn",a.sortUserList),$(document).on("click",".ucVisitorPageTrigger",a.openVisitorProfile),$(document).on("click","#ucVisitorPageBackBtn",a.closeVisitorProfile),$("#uc_visitor_list .ucUserListSortableColumn .fa-caret-up").hide(),$("#uc_visitor_list .ucUserListSortableColumn .fa-caret-down").hide(),$(document).on("click","#uc-all-user-select",a.userListSelectHandler),$(document).on("change","#uc-all-user-select,.uc-user-select",a.updateRecipientCount),$("#ucVisitorFieldsPopover").popover({html:!0,content:function(){return a.getOrderedFieldsForPopover()}}),$("#ucVisitorFieldsPopover").on("shown.bs.popover",function(){$(".ucVisitorFieldList").sortable()}),$("#ucVisitorFieldsPopover").on("shown.bs.popover",function(){for(var b=0;b<a.displayFields.length;b++)$(".ucVisitorFieldList").find('[data-fieldid="'+a.displayFields[b]+'"]').prop("checked",!0)}),$(document).on("click","#ucVisitorFieldsPopoverSubmit",a.saveFieldsListHandler),$(document).on("click","#ucVisitorSearchBtn",a.searchHandler))},this.initRivetBinds=function(){a.rivetVisitorListObj=rivets.bind(document.querySelector("#uc_visitor_list"),{list:a.visitors,fieldList:[]}),rivets.binders.visitorid=function(a,b){$(a).attr("id","uc-user-select-"+b._id),$(a).attr("data-visitorid",b._id),$(a).next("label").attr("for","uc-user-select-"+b._id)},rivets.binders.latestbrowser=function(a,b){var c=b[0].agentInfo.browser,d=b[0].agentInfo.version,e=d.split(".");e.length>2&&(d=e[0]+"."+e[1]);var f="chrome";b[0].agentInfo.rawAgentData.isChrome&&(f="chrome"),b[0].agentInfo.rawAgentData.isSafari&&(f="safari"),b[0].agentInfo.rawAgentData.isFirefox&&(f="firefox"),b[0].agentInfo.rawAgentData.isEdge&&(f="edge"),b[0].agentInfo.rawAgentData.isIE&&(f="ie"),$(a).html(c+" <span>(v"+d+")</span>"),$(a).removeClass("chrome safari firefox edge ie"),$(a).addClass(f)},rivets.binders.latestplatform=function(a,b){var c=b[0].agentInfo.os,d="windows";b[0].agentInfo.rawAgentData.isWindows&&(d="windows"),(b[0].agentInfo.rawAgentData.isMac||b[0].agentInfo.rawAgentData.isiPad||b[0].agentInfo.rawAgentData.isiPod||b[0].agentInfo.rawAgentData.isiPhone)&&(d="ios"),(b[0].agentInfo.rawAgentData.isLinux||b[0].agentInfo.rawAgentData.isLinux64)&&(d="linux"),b[0].agentInfo.rawAgentData.isAndroid&&(d="android"),$(a).html(c),$(a).removeClass("ios android windows linux"),$(a).addClass(d)},rivets.binders.sessioncount=function(a,b){$(a).html(b.length)},rivets.binders.profilepicture=function(a,b){if(null!=b.profilepicture&&""!=b.profilepicture)$(a).find(".ucUserProfileImage").attr("src",b.profilepicture).show(),$(a).find(".ucUserProfileIntial").hide();else{var c=UC_Utils.getProfileColor(b.name);$(a).find(".ucUserProfileIntial").css({"background-color":c}).text(b.name[0]).show(),$(a).find(".ucUserProfileImage").hide()}},a.rivetVisitorColumnListObj=rivets.bind(document.querySelector("#ucVisitorFieldList"),{fieldList:[]}),rivets.binders.customfieldheader=function(a,b){$(a).addClass("ucVisitorListToggleField_"+b.value),$(a).attr("data-sortColumn","visitorData."+b.value),$(a).find(".ucVisitorListHeaderLabel").html(b.label)},rivets.binders.customfielddata=function(a,b){$(a).addClass("ucVisitorListToggleField_"+b.value),$(a).attr("data-customField",b.value),$(a).html("{visitor.visitorData.name}"),$(a).find(".ucVisitorListHeaderLabel").html(b.label)},rivets.binders.customfieldtest=function(a,b){var c=b[$(a).attr("data-customField")];"created_at"==$(a).attr("data-customField")&&(c=moment(c).format("Do MMM YY, HH:mm")),$(a).text(c)},rivets.binders.country=function(a,b){""!=b[0].geoLocationInfo.country?$(a).html("<span data-toggle='tooltip' data-placement='left'  class='mfTooltip flag "+b[0].geoLocationInfo.country.toLowerCase()+"' data-original-title='"+b[0].geoLocationInfo.countryName+"'></span>"):$(a).html("")},rivets.binders.lastseen=function(a,b){$(a).html(moment(b).format("Do MMM YY, HH:mm"))},rivets.binders.firstseen=function(a,b){$(a).html(moment(b).format("Do MMM YY, HH:mm"))},a.rivetVisitorPlaceholderObj=rivets.bind(document.querySelector("#ucVisitorListPlaceholder"),{display:!1}),a.rivetVisitorMessagesObj=rivets.bind(document.querySelector("#ucVisitorMessages"),{messageList:[]}),a.rivetVisitorSessionsObj=rivets.bind(document.querySelector("#ucVisitorActivity"),{ActivityList:[]})},this.getAllVisitors=function(b){if(void 0===b&&(b=null),uc_main.appController.currentAppId&&!a.visitorListInProcess){a.visitorListInProcess=!0;var c=a.currentFilterId;"dashboard"==c&&(c="1"),$("#ucVisitorListAjaxLoader").show(),UC_AJAX.call("VisitorListManager/visitorlist",{appid:uc_main.appController.currentAppId,skipindex:a.visitorListSkipIndex,pagelimit:a.visitorListPageLimit,filterid:c,sortColumn:a.currentSortColumn,sortOrder:a.currentSortOrder,mongoFilterQuery:b},function(b,d,e){"failure"==b.status?alert("An Error accured while fetching visitors list !"):"authenticationfailed"==b.status?location.href="/":(1==b.totalcount.length?a.currentFilterTotalVisitors=b.totalcount[0].count:a.currentFilterTotalVisitors=0,a.visitors=a.visitors.concat(b.status),a.visitorListSkipIndex=a.visitorListSkipIndex+b.status.length,a.visitors.length>=a.currentFilterTotalVisitors&&(a.visitorListLoaded=!0),a.listVisitors(b.status),$("#ucPredefinedFilterList").find("li[data-filterid="+c+"] .ucFilterListVisitorCount").text(a.currentFilterTotalVisitors),$("#ucUserdefinedFilterList").find("li[data-filterid="+c+"] .ucFilterListVisitorCount").text(a.currentFilterTotalVisitors)),a.updateRecipientCount(),$("#ucVisitorListAjaxLoader").hide(),$("#ucPageLoader").hide(),a.visitorListInProcess=!1})}},this.listVisitors=function(b){for(var c=0;c<a.visitors.length;c++)a.visitors[c].isVisitorOnline=!1,a.visitors[c].isVisitorOffline=!0;a.rivetVisitorListObj.models.list=a.rivetVisitorListObj.models.list.concat(b),a.checkVisitorPresence(a.visitors),a.selectCurrentSort(),a.toggleVisitorListFields(),"1"==a.currentFilterId&&0==a.visitors.length?a.rivetVisitorPlaceholderObj.models.display=!0:a.rivetVisitorPlaceholderObj.models.display=!1},this.sortUserList=function(){var b=$(this).attr("data-sortColumn");b==a.currentSortColumn?1===a.currentSortOrder?a.currentSortOrder=-1:a.currentSortOrder=1:(a.currentSortColumn=b,a.currentSortOrder=-1),UC_UserSession.user.hasOwnProperty("app")||(UC_UserSession.user.app={}),UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)||(UC_UserSession.user.app[uc_main.appController.currentAppId]={}),UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder={}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder.hasOwnProperty(a.currentFilterId)||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId]={currentSortColumn:"visitorMetaInfo.lastSeen",currentSortOrder:1,displayFields:[]}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].currentSortColumn=a.currentSortColumn,UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].currentSortOrder=a.currentSortOrder,uc_main.filterController.saveAppPreference(),a.resetPagination(),a.getAllVisitors()},this.resetPagination=function(){a.visitors=[],a.visitorListSkipIndex=0,a.visitorListLoaded=!1,$("#uc-all-user-select").prop("checked",!1),a.rivetVisitorPlaceholderObj.models.display=!1,a.rivetVisitorListObj.models.list=[]},this.openVisitorProfile=function(){a.getVisitorDetails($(this).attr("data-visitorid")),$(".ucVisitorPageWrapper").show(),$(".ucIndexPageWrapper").hide(),history.pushState("",document.title,window.location.pathname+window.location.search+"visitor/"+$(this).attr("data-visitorid"))},this.closeVisitorProfile=function(){$(".ucIndexPageWrapper").show(),$(".ucVisitorPageWrapper").hide(),history.pushState("",document.title,"/")},this.selectCurrentSort=function(){$("#uc_visitor_list .ucUserListSortableColumn .fa-caret-up").hide(),$("#uc_visitor_list .ucUserListSortableColumn .fa-caret-down").hide(),1===a.currentSortOrder?$("#uc_visitor_list .ucUserListSortableColumn[data-sortColumn='"+a.currentSortColumn+"'] .fa-caret-up").show():$("#uc_visitor_list .ucUserListSortableColumn[data-sortColumn='"+a.currentSortColumn+"'] .fa-caret-down").show()},this.userListSelectHandler=function(){$("#uc-all-user-select").is(":checked")?($(".uc-user-select").prop("checked",!0),$("#ucSendMessageGroupBtn").text("Send Message to All"),$("#ucSendMessageEmailSubmit,#ucSendMessageBrowserNotificationSubmit").text("Send to All")):($(".uc-user-select").prop("checked",!1),$("#ucSendMessageGroupBtn").text("Send Message"),$("#ucSendMessageEmailSubmit,#ucSendMessageBrowserNotificationSubmit").text("Send"))},this.updateRecipientCount=function(){var b=0;$("#uc-all-user-select").is(":checked")?(b=a.currentFilterTotalVisitors,$(".uc-user-select").each(function(){$(this).is(":checked")||b--})):$(".uc-user-select").each(function(){$(this).is(":checked")&&b++}),0!=b?$("#ucSendMessageGroupBtn").prop("disabled",!1):$("#ucSendMessageGroupBtn").prop("disabled",!0),$("#ucSendMessageGroupBtn,#ucSendMessageEmailSubmit,#ucSendMessageBrowserNotificationSubmit").text("Send to "+b+" users")},this.getVisitorDetails=function(b){null!=b&&(a.visitorId=b,$("#ucVisitorDetailAjaxLoader").show(),UC_AJAX.call("VisitorListManager/getvisitordetails",{appid:uc_main.appController.currentAppId,visitorId:b},function(b,c,d){if("failure"==b.status)alert("An Error accured while fetching user details !");else if("authenticationfailed"==b.status||"notfound"==b.status)location.href="/";else{if(null!=b.visitor){var e=b.visitor;e.displayId=e._id.substring(0,10)+"...",e.displaySessionCount=e.sessions.length,e.displayLastSeen=moment(e.visitorMetaInfo.lastSeen).format("DD MMM YYYY HH:mm:ss"),e.displayFirstSeen=moment(e.visitorMetaInfo.firstSeen).format("DD MMM YYYY HH:mm:ss"),a.rivetVisitorDetailsObj=rivets.bind(document.querySelector("#ucVisitorDetail"),{visitor:e})}$("#ucVisitorDetailAjaxLoader").hide(),$("#ucVisitorDetailTable").show()}}),$("#ucVisitorMessageAjaxLoader").show(),UC_AJAX.call("VisitorListManager/getvisitormessages",{appid:uc_main.appController.currentAppId,visitorId:b},function(b,c,d){if("failure"==b.status)alert("An Error accured while fetching user details !");else if("authenticationfailed"==b.status)location.href="/";else{if(null!=b.messages){for(var e=b.messages,f=0;f<e.length;f++)e[f].displayDate=moment(e[f].sentOn).format("DD MMM YYYY HH:mm:ss");a.rivetVisitorMessagesObj.models.messageList=e}$("#ucVisitorMessageAjaxLoader").hide(),$("#ucVisitorMessages").show()}})),$(window).scroll(function(){$(window).scrollTop()+$(window).height()==$(document).height()&&(a.activityListloaded||a.getVisitorActivity(a.visitorId))}),a.resetActivities(),a.getVisitorActivity(b)},this.getVisitorActivity=function(b){$("#ucVisitorActivity").hide(),$("#ucVisitorActivityAjaxLoader").show(),UC_AJAX.call("VisitorListManager/getvisitorsessions",{visitorId:b,skipindex:a.activityListSkipIndex,pagelimit:a.activityListPageLimit},function(b,c,d){if("failure"==b.status)alert("An Error accured while fetching user details !");else if("authenticationfailed"==b.status)location.href="/";else{if(null!=b.sessions){var e=b.sessions;0==e.length&&(a.activityListloaded=!0),a.activityListSkipIndex=a.activityListSkipIndex+e.length;for(var f=0;f<e.length;f++)e[f].sessions=e[f].sessions[0],e[f].sessions.agentInfo.sessionStart=moment(e[f].sessions.agentInfo.sessionStart).format("DD MMM YYYY HH:mm:ss"),"Logged In"==e[f].eventName?e[f].eventType=e[f].sessions.agentInfo.device+"-"+e[f].sessions.agentInfo.platform+"-"+e[f].sessions.agentInfo.os+"-"+e[f].sessions.agentInfo.browser+"-"+e[f].sessions.agentInfo.version:e[f].eventType=JSON.stringify(e[f].eventProperties);a.activities=a.activities.concat(e),a.rivetVisitorSessionsObj.models.ActivityList=a.activities}$("#ucVisitorActivityAjaxLoader").hide(),$("#ucVisitorActivity").show()}})},this.resetActivities=function(){a.activities=[],a.rivetVisitorSessionsObj.models.ActivityList=a.activities,a.activityListSkipIndex=0,a.activityListloaded=!1},this.getFieldsList=function(){UC_AJAX.call("VisitorListManager/getfieldslist",{appid:uc_main.appController.currentAppId,user:UC_UserSession.user},function(b,c,d){if("failure"==b.status)alert("Error while getting field list");else if("authenticationfailed"==b.status)location.href="/";else{for(var e=[],f=0;f<b.fields.length;f++)if("name"!=b.fields[f]){var g={};g.value=b.fields[f],g.label=b.fields[f],g.label=g.label.replace("_"," "),g.label=g.label.charAt(0).toUpperCase()+g.label.slice(1),e.push(g)}var h=[{value:"browser",label:"Browser"},{value:"os",label:"Operating System"},{value:"device",label:"Device"},{value:"country",label:"Country"},{value:"lastseen",label:"Last Seen"},{value:"firstseen",label:"First Seen"}];a.rivetVisitorColumnListObj.models.fieldList=h.concat(e),a.rivetVisitorListObj.models.fieldList=e,a.resetPagination(),a.getAllVisitors()}})},this.saveFieldsListHandler=function(){a.displayFields=[];var b=[];$(".ucVisitorFieldList").find("li").each(function(){b.push($(this).find(".ucVisitorFieldListItem").attr("data-fieldid")),$(this).find(".ucVisitorFieldListItem").is(":checked")&&a.displayFields.push($(this).find(".ucVisitorFieldListItem").attr("data-fieldid"))}),$("#ucVisitorFieldsPopover").popover("hide"),UC_UserSession.user.hasOwnProperty("app")||(UC_UserSession.user.app={}),UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)||(UC_UserSession.user.app[uc_main.appController.currentAppId]={}),UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder={}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder.hasOwnProperty(a.currentFilterId)||(UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId]={currentSortColumn:"visitorMetaInfo.lastSeen",currentSortOrder:1,displayFields:[]}),UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].displayFields=a.displayFields,UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].fieldsOrder=b,uc_main.filterController.saveAppPreference(),a.reorderFieldsInUserlist(),a.toggleVisitorListFields()},this.toggleVisitorListFields=function(){$(".ucVisitorListToggleField").hide();for(var b=0;b<a.displayFields.length;b++)$(".ucVisitorListToggleField_"+a.displayFields[b]).show();$(".mfTooltip").tooltip()},this.getOrderedFieldsForPopover=function(){var b=$("#ucVisitorFieldsPopoverContent").clone();if(UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)&&UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")&&UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder.hasOwnProperty(a.currentFilterId)&&UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].hasOwnProperty("fieldsOrder")){for(var c=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].fieldsOrder,d="",e=0;e<c.length;e++)d+=$(b).find("li[data-fieldid='"+c[e]+"']").prop("outerHTML"),$(b).find("li[data-fieldid='"+c[e]+"']").remove();$(b).find("#ucVisitorFieldList").prepend(d)}return $(b).find("#ucVisitorFieldList").removeAttr("id").addClass("ucVisitorFieldList"),$(b).html()},this.reorderFieldsInUserlist=function(){var b=[];UC_UserSession.user.hasOwnProperty("app")&&UC_UserSession.user.app.hasOwnProperty(uc_main.appController.currentAppId)&&UC_UserSession.user.app[uc_main.appController.currentAppId].hasOwnProperty("filterOrder")&&UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder.hasOwnProperty(a.currentFilterId)&&UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].hasOwnProperty("fieldsOrder")?b=UC_UserSession.user.app[uc_main.appController.currentAppId].filterOrder[a.currentFilterId].fieldsOrder:$("#ucVisitorFieldList").find("li").each(function(){b.push($(this).find(".ucVisitorFieldListItem").attr("data-fieldid"))}),$(".ucTableRow").each(function(){for(var a=".ucVisitorListSession",c=0;c<b.length;c++){var d=$(this).find(".ucVisitorListToggleField_"+b[c]).clone();$(this).find(".ucVisitorListToggleField_"+b[c]).remove(),$(d).insertAfter($(this).find(a)),a=".ucVisitorListToggleField_"+b[c]}})},this.searchHandler=function(b){b.preventDefault();var c=$("#ucVisitorSearchField").val(),d=$("#ucVisitorSearchValue").val(),e='{ "$and": [ { "'+c+'": { "$regex": "'+d+'" } } ] }';a.resetPagination(),a.getAllVisitors(e)},this.newVisitorAction=function(b){a.newVisitors=a.newVisitors+1,$(".ucNewVisitorNotificationMsgCls").remove(),$(".ucSearchBar").after("<p style='padding-left: 15px;font-size: 11px;color: #2b9af3;cursor:pointer' class='ucNewVisitorNotificationMsgCls'>"+a.newVisitors+" user(s) have arrived since you have logged in.Click to refresh the visitor's list.</p>"),$(".ucNewVisitorNotificationMsgCls").on("click",function(){a.getAllVisitors(),$(this).remove()})},this.checkVisitorPresence=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].visitorData.email+"-"+uc_main.appController.currentAppId;b.push(d)}var e={};e.name="userpresence",e.visitors=b,uc_main.rtcController.sendMessageToServer(JSON.stringify(e))}}var UC_AJAX=new UC_AJAXController,UC_UserSession={user:null,getUser:function(){return this.user}},UC_Utils=function(){return{guidGenerator:function(){var a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return a()+a()+a()+a()+a()+a()+a()+a()},isValidEmail:function(a){return/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(a)},searchObjArray:function(a,b,c){var d=-1;return a.forEach(function(a,e){if(a[b]===c)return void(d=e)}),d},getParameterByName:function(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null},getProfileColor:function(a){for(var b=["#446CB3","#8E44AD","#26A65B","#F89406","#6C7A89","#34495E"],c=0,d=0;d<a.length;d++)c+=a.charCodeAt(d)*d;return c=Math.round(c/a.length),b[c%b.length]}}}();self.addEventListener("push",function(a){var b={};a.data&&(b=a.data.json());var c=b.title||"Usercom",d=b.message||"There is a new message for you";self.registration.showNotification(c,{body:d,icon:b.icon,data:{url:b.url}})}),self.addEventListener("notificationclick",function(a){var b=a.notification.data,c=new Promise(function(a){setTimeout(a,300)}).then(function(){return clients.openWindow(b.url)});a.notification.close(),a.waitUntil(c)});var DEFAULT_CONFIG={api_baseurl:"VARIABLE_BASEURL",api_host:"VARIABLE_APIHOST",serviceWorkerFile:"/usercom-sw.js"},SERVICES=["trackEvent"],Usercom={props:{sessionId:null,visitorId:null,appid:null},init:function(a){var b="VARIABLE_APPID",c=this;if(0==b.length)return void console.error("Usercom Error: Invalid app id !");window.usercomlib={},usercomlib.appid=b,usercomlib.userdata=a,c.bindGlobalErrorHandler(usercomlib),c.props.appid=b;var d={appid:b,userdata:a,uid:utils.guidGenerator(),screenResolution:screen.width+"x"+screen.height,timezone:-(new Date).getTimezoneOffset()/60};xhr.raw(DEFAULT_CONFIG.api_baseurl+"/VisitorTrackingManager/ping",JSON.stringify(d),function(a){var b=JSON.parse(a);c.props.sessionId=b.sessionId,c.props.visitorId=b.status._id,usercomlib.sessionId=b.sessionId,usercomlib.visitorId=b.status._id,c.establishSocketConnection(usercomlib),c.initServices(),usercomlib.trackEvent("Logged In",{})})},track:function(a,b){window.usercomlib.trackEvent?usercomlib.trackEvent(a,b):setTimeout(function(){Usercom.track(a,b)},500)},establishSocketConnection:function(a){var b="ws",c="8001";"https:"==location.protocol&&(b="wss",c="8002");var d=new WebSocket(b+"://"+DEFAULT_CONFIG.api_host+":"+c+"/");d.onopen=function(){var b={};b.name="establishvisitorconnection",b.key=a.userdata.email+"-"+a.appid+"-"+a.sessionId,b=JSON.stringify(b),d.send(b)},d.onclose=function(){d.send("closing")}},bindGlobalErrorHandler:function(a){var b=window.onerror;window.onerror=function(c,d,e,f,g){b&&b.apply(this,arguments);var h=["Message: "+c,"URL: "+d,"Line: "+e,"Column: "+f,"Error object: "+JSON.stringify(g)].join(" - "),i={appid:a.appid,userdata:a.userData,errormsg:h,uid:utils.guidGenerator()};return xhr.raw(DEFAULT_CONFIG.api_baseurl+"/VisitorTrackingManager/error",JSON.stringify(i),function(a){}),!1}},initServices:function(){for(var a=0;a<SERVICES.length;a++)try{window[SERVICES[a]]()}catch(b){console.log(SERVICES[a]+" service is not present  !")}}},HTTP_PROTOCOL="https:"===document.location.protocol?"https://":"http://",utils={guidGenerator:function(){var a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return a()+a()+a()+a()+a()+a()+a()+a()},extendObj:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}},cookie={createCookie:function(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toUTCString()}document.cookie=a+"="+b+d+"; path=/"},readCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return null},eraseCookie:function(a){createCookie(a,"",-1)}},xhr={formdata:function(a,b,c){try{var d=new XMLHttpRequest;d.open(b?"POST":"GET",a,1),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),d.onreadystatechange=function(){d.readyState>3&&callback&&callback(d.responseText,d)},d.send(b)}catch(a){window.console&&console.log(a)}},raw:function(a,b,c){try{var d=new XMLHttpRequest;d.open(b?"POST":"GET",a,1),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.setRequestHeader("Content-type","application/json"),d.onreadystatechange=function(){d.readyState>3&&c&&c(d.responseText,d)},d.send(b)}catch(a){window.console&&console.log(a)}}};